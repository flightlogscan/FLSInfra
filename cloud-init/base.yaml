package_update: true
package_upgrade: true

users:
  - name: gha
    groups: [sudo, docker]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL

packages:
  - openjdk-21-jdk
  - docker.io
  - caddy
  - curl
  - unzip

write_files:
  - path: /etc/caddy/Caddyfile
    owner: root:root
    permissions: '0644'
    content: |
      api.flightlogscan.com {
          reverse_proxy localhost:8080
      }

      http://api.flightlogscan.com {
          redir https://{host}{uri} permanent
      }
  - path: /opt/flightlogscan/bin/deploy.sh
    owner: gha:gha
    permissions: '0755'
    content: |
      ${deploy_script}
  - path: /etc/github_runner.env
    owner: gha:gha
    permissions: '0600'
    content: |
      GITHUB_TOKEN=${github_runner_token}

run cmd:
  - systemctl enable --now docker
  - mkdir -p /var/log/FLTSpring
  - chown gha:gha /var/log/FLTSpring
  - chmod 755 /var/log/FLTSpring
  - systemctl reload caddy
  - systemctl disable --now ssh
  - mkdir -p /actions-runner && cd /actions-runner
  - curl -O -L https://github.com/actions/runner/releases/download/v2.315.0/actions-runner-linux-x64-2.315.0.tar.gz
  - tar xzf actions-runner-linux-x64-2.315.0.tar.gz
  - ./bin/installdependencies.sh
  - source /etc/github_runner.env && ./config.sh --unattended --url https://github.com/flightlogscan/FLTSpring --token ${GITHUB_TOKEN} --labels hetzner --name $(hostname)
  - ./svc.sh install
  - ./svc.sh start